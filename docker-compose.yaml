version: '3.7'
services:
  nginx:
    image: nginx
    volumes:
      - ./conf/nginx.conf:/etc/nginx/nginx.conf
      - ./conf/conf.d:/etc/nginx/conf.d
      - ./conf/ssl:/etc/nginx/ssl
      - ./well-known:/usr/share/nginx/html
      - /opt/letsencrypt:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    networks:
      dnet:

  frontend:
    image: salmasov/stuffy-helper-frontend
    ports:
      - 8080:80
    restart: unless-stopped
    networks:
      dnet:
      
  api:
    image: slavadno/stuffyhelper
    build: .
    ports:
      - 7777:8080
    environment:
      - Authorization__ConnectionString=${AUTH_CONN_STR}
      - Authorization__JWT__Secret==${AUTH_JWT_SECRET}
      - Authorization__JWT__ValidIssuer=${AUTH_JWT_ISSUER}
      - Authorization__JWT__ValidAudience=${AUTH_JWT_AUDIENCE}
      - EntityFramework__DbProvider=${EF_PROVIDER}
      - EntityFramework__ConnectionString=${EF_CONN_STR}
      - MinioStore__Endpoint=${MINIO_ENDPOINT}
      - MinioStore__AccessKey=${MINIO_ACCESS}
      - MinioStore__SecretKey=${MINIO_SECRET}
      - MinioStore__NetworkTimeout=3600
      - MinioStore__PresignedUrlExpiry=12:00:00
      - StuffyFileWeb__StuffyFileStore__ContainerName=${FILE_CONTAINER_NAME}
      - EmailService__Server=${EMAIL_SERVER}
      - EmailService__Port=${EMAIL_PORT}
      - EmailService__Account=${EMAIL_ACCOUNT}
      - EmailService__Password=${EMAIL_PASSWORD}
      - EmailService__SenderEmail=${EMAIL_SENDER_EMAIL}
      - EmailService__SenderName=${EMAIL_SENDER_NAME}
      - Frontend__Endpoint=${FRONTEND_ENDPOINT}
    depends_on:
      - postgres-web
      - s3
    restart: unless-stopped
    networks:
      dnet:

  postgres-web:
    image: postgres:12.4-alpine
    environment:
        - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_MULTIPLE_DATABASES}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
        - ../stuffydata/postgresql/data:/var/lib/postgresql/data
    restart: unless-stopped
    
  s3:
    image: minio/minio
    ports:
      - <ports>
    volumes:
      - ../stuffydata/minio/data:/data
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS}
      MINIO_SECRET_KEY: ${MINIO_SECRET}
    command: server /data

  networks:
    dnet:
      name: dnet
      driver: bridge